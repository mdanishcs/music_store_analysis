-- Question Set-1 Easy

-- 1. Who is senior most employee based on job title?
select * from employee order by levels desc limit 1;
-- Ans- Madan Mohan, SGM

-- 2. Whic countries hav the most invoice?
select billing_country as country, count(invoice_id) as no_invoice 
from invoice 
group by billing_country 
order by count(invoice_id) desc;
-- Ans- USA - 131 > Canada - 76 > Brazil - 61 and so on

-- 3. What are top 3 values of total invoice?
select total from invoice order by total desc limit 3;
-- Ans- 23.76 > 19.8 >19.8


-- 4. Which city has tha best customers? We would like to throw a promotional 
-- Music Festival in the city we made the most money. Write a query that returns one city 
-- that has the highest sum of invoice totals. Return both the cityname and sum of all invoices totals.
select billing_city as city, sum(total) as invoice_total from invoice 
group by billing_city order by sum(total) desc limit 1;
-- Ans- Prague, 273.24

-- 5. Who is the best customer? The customer who has spent the most money will be declared 
-- the best customer. Write a query that returns the person who has spent the most money.
select c.customer_id, c.first_name, c.last_name , sum(total) as spent_money
from invoice i 
join customer c on i.customer_id = c.customer_id
group by c.customer_id, c.first_name, c.last_name order by sum(total) desc limit 1;
-- Ans - 5, Frantisek, Wichterlova, 144.54

---------------------------------------------------------------------------------------------
-- Question set - 2 Moderate

-- 1. Write a query to return tha email, first name , last name, & genre of all rock music listners.
-- Return Your list orderd alphabetically by email starting with 'A'.
select distinct(c.email), c.first_name, c.last_name, g.name from customer c
join invoice i on c.customer_id = i.customer_id
join invoice_line il on i.invoice_id = il.invoice_id
join track t on il.track_id = t.track_id
join genre g on t.genre_id = g.genre_id
where g.name like 'Rock' 
order by c.email;

-- OR
select distinct email, first_name, last_name from customer c
join invoice i on c.customer_id = i.customer_id
join invoice_line il on i.invoice_id = il.invoice_id
where track_id in (
	select track_id from track t
	join genre g on t.genre_id = g.genre_id
	where g.name like 'Rock'
)
order by email;

-- 2. Let's invite the artists who have writen the most rock music in our dataset. 
-- Write a query that returns the artist's name and total track count of the top 10 rock bands.
select ar.name, count(t.name) as no_tracks from artist ar
join album al on ar.artist_id = al.artist_id
join track t on al.album_id = t.album_id
join genre g on t.genre_id = g.genre_id
where g.name like 'Rock' 
group by ar.name order by count(t.name) desc limit 10;


-- 3. Return all the track's name that have a 'song length' longer than the average 'song length'. 
--  Return the 'name' and 'miliseconds' for each track. 
-- Order by the 'song length' with the longest listed first.
select name, milliseconds from track 
where milliseconds > (
	select  avg(milliseconds) from track)
order by  milliseconds desc ;

-------------------------------------------------------------------------------------------------------------

-- Question set - 3 Advenced

-- 1. Find how much amount spent by each customer on artists?
-- Write a query customer name , artist name and total spent.
select c.first_name, ar.name,sum(il.unit_price * quantity) from customer c
join invoice i on c.customer_id = i.customer_id
join invoice_line il on i.invoice_id = il.invoice_id
join track t on il.track_id = t.track_id
join album al on t.album_id = al.album_id
join artist ar on al.artist_id = ar.artist_id
group by c.first_name, ar.name 
order by sum(il.unit_price * quantity) desc ; 


-- For one Higehst selling artist
with best_selling_artist as(
	select ar.artist_id, ar.name, sum(il.unit_price * quantity) as total_spent 
	from invoice_line il
	join track t on il.track_id = t.track_id
	join album al on t.album_id = al.album_id
	join artist ar on al.artist_id = ar.artist_id
	group by 1, 2
	order by 3 desc limit 1
)
select c.cust from customer c
join invoice i on c.customer_id = i.customer_id
join invoice_line il on i.invoice_id = il.invoice_id
join track t on il.track_id = t.track_id
join album al on t.album_id = al.album_id
join best_selling_artist bsa on al.artist_id = bsa.artist_id
;


-- 2. We want to find out the most popular genre for each country. We determine the most popular genre 
-- as the genre with the highest amount of purchases. Write a qwery that returns each country along 
-- with tha top genre. For country where tha maximum number of purchases is shared return all genres.
with populara_grnre as(
	select count(il.quantity), c.country, g.name,
	row_number() over(partition by c.country order by count(*) desc)
	from invoice i
	join customer c on i.customer_id = c.customer_id
	join invoice_line il on i.invoice_id = il.invoice_id
	join track t on il.track_id = t.track_id
	join genre g on t.genre_id = g.genre_id
	group by 2,3
	order by 2 asc, 1 desc
)
select * from populara_grnre order by 4,2;

-- 3. Write a query that determines the customer that has spent the most on music for each country.
-- Write a query that returns the country along the top cuatomernsand how much the spent. 
-- For countries where the top amount spent is shared, provide all customers who spent this amount.
with recursive customer_with_country as(
	select c.customer_id, c.first_name, c.last_name, i.billing_country , sum(i.total) as total_spending from customer c 
	join invoice i on c.customer_id = i.customer_id
	group by 1,2,3,4 order by 2,3 desc),

	country_max_spending as(
		select billing_country, max(total_spending) as max_spending 
		from customer_with_country group by 1
	)

select cwc.billing_country, cwc.total_spending, cwc.first_name, cwc.last_name
from customer_with_country cwc
join country_max_spending cms on cwc.billing_country = cms.billing_country
where cwc.total_spending = cms.max_spending
order by 1;



